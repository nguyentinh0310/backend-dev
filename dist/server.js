(()=>{"use strict";var e={6752:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(9905),r=o(i(9710)),a=o(i(3582)),u=o(i(6860)),d=o(i(7806)),c=o(i(3487)),l=o(i(3685)),h=o(i(1185)),f=o(i(9470)),p=o(i(7455)),v=o(i(3952)),m=o(i(9948)),y=o(i(5477));t.default=class{constructor(e){this.app=(0,u.default)(),this.server=l.default.createServer(this.app),this.io=new v.default.Server(this.server),this.port=process.env.PORT||5e3,this.production=!0,this.connectDatabase(),this.initializeMiddleware(),this.initializeRoutes(e),this.initializeErrorMiddleware(),this.initializeSwagger(),this.initSocketIo()}initSocketIo(){this.server=l.default.createServer(this.app),this.io=new v.default.Server(this.server,{cors:{origin:"*"}}),this.app.set("socketio",this.io),this.io.on("connection",(e=>{n.Logger.warn("a user connected : "+e.id),(0,p.default)(e)}))}listen(){this.server.listen(this.port,(()=>{n.Logger.info(`Server is listening on port ${this.port}`)}))}initializeRoutes(e){e.forEach((e=>{this.app.use("/",e.router)}))}initializeMiddleware(){this.production?(this.app.use((0,c.default)()),this.app.use((0,d.default)()),this.app.use((0,f.default)("combined"))):this.app.use((0,f.default)("dev")),this.app.use((0,a.default)({origin:!0,credentials:!0})),this.app.use(u.default.json()),this.app.use(u.default.urlencoded({extended:!0})),this.app.use((0,r.default)())}initializeErrorMiddleware(){this.app.use(s.errorMiddleware)}connectDatabase(){const e=process.env.MONGODB_URI;e?h.default.connect(e,{useNewUrlParser:!0,useUnifiedTopology:!0},(e=>{e?(n.Logger.error("Can not to mongodb!"),n.Logger.error(e)):n.Logger.info("Connected to MongoDB")})):n.Logger.error("Connection string is invalid")}initializeSwagger(){const e=y.default.load("./src/swagger.yaml");this.app.use("/swagger",m.default.serve,m.default.setup(e))}}},4427:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class i extends Error{constructor(e,t){super(t),this.status=e,this.message=t}}t.default=i},5729:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HttpException=void 0;const s=o(i(4427));t.HttpException=s.default},167:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i(2333);t.default=(e,t,i)=>o(void 0,void 0,void 0,(function*(){try{if(1!==(yield s.UserSchema.findOne({_id:e.user.id}).exec()).role)return t.status(400).json({message:"Admin resources access denied."});i()}catch(e){i(e)}}))},3973:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(9905),n=o(i(9344));t.default=(e,t,i)=>{var o;e.cookies;const r=e.header("Authorization");if(!r)return t.status(401).json({message:"No token, authorization denied."});try{const t=n.default.verify(r,null!==(o=process.env.ACCESS_TOKEN_SECRET)&&void 0!==o?o:"");e.user||(e.user={id:""}),e.user.id=t.id,i()}catch(e){s.Logger.error(`[ERROR] Msg: ${r}`),"TokenExpiredError"===e.name?t.status(401).json({message:"Token is expired"}):t.status(401).json({message:"Token is not valid"})}}},4492:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=i(9905);t.default=(e,t,i,s)=>{const n=e.status||500,r=e.message||"Some thing when wrong";o.Logger.error(`[ERROR] - Status: ${n} - Msg: ${r}`),i.status(n).json({message:r})}},7382:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authAdmin=t.authMiddleware=t.validationMiddleware=t.errorMiddleware=void 0;const s=o(i(167));t.authAdmin=s.default;const n=o(i(3973));t.authMiddleware=n.default;const r=o(i(4492));t.errorMiddleware=r.default;const a=o(i(5752));t.validationMiddleware=a.default},5752:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=i(5849),s=i(5729),n=i(136);t.default=(e,t=!1)=>(i,r,a)=>{(0,o.validate)((0,n.plainToClass)(e,i.body),{skipMissingProperties:t}).then((e=>{if(e.length>0){const t=e.map((e=>Object.values(e.constraints))).join(", ");a(new s.HttpException(400,t))}else a()}))}},7417:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t){this.query=e,this.queryString=t}paginating(){const e=1*this.queryString.page||1,t=1*this.queryString.limit||15,i=t*(e-1);return this.query=this.query.limit(t).skip(i),this}sorting(){const e=this.queryString.sort||"-createdAt";return this.query=this.query.sort(e),this}searching(){let e=this.queryString.search;return e=new RegExp(e,"i"),this.query=e?this.query.find({$text:{$search:e}}):this.query.find(),this}filtering(){const e=Object.assign({},this.queryString);["page","sort","limit","search"].forEach((t=>delete e[t]));let t=JSON.stringify(e);return t=t.replace(/\b(gte|gt|lt|lte|regex)\b/g,(e=>"$"+e)),this.query=this.query.find(JSON.parse(t)),this}}},7093:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.randomTokenString=t.generateJwtToken=t.generateRefreshToken=t.generateAccessToken=t.generateActiveToken=t.isEmptyObject=void 0;const s=o(i(9344)),n=o(i(6113));t.isEmptyObject=e=>!Object.keys(e).length,t.generateActiveToken=e=>s.default.sign(e,`${process.env.ACTIVE_TOKEN_SECRET}`,{expiresIn:"5m"}),t.generateAccessToken=e=>s.default.sign(e,`${process.env.ACCESS_TOKEN_SECRET}`,{expiresIn:"1d"}),t.generateRefreshToken=e=>s.default.sign(e,`${process.env.REFRESH_TOKEN_SECRET}`,{expiresIn:"7d"}),t.generateJwtToken=(e,t)=>{var i;const o={id:e},n=null!==(i=process.env.ACCESS_TOKEN_SECRET)&&void 0!==i?i:"";return{access_token:s.default.sign(o,n,{expiresIn:"1d"}),refresh_token:t,expiredAt:"1d"}},t.randomTokenString=()=>n.default.randomBytes(40).toString("hex")},9905:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.APIfeatures=t.validPhone=t.validateEmail=t.sendMail=t.generateRefreshToken=t.generateAccessToken=t.generateJwtToken=t.randomTokenString=t.generateActiveToken=t.isEmptyObject=t.validateEnv=t.Logger=void 0;const s=o(i(7417));t.APIfeatures=s.default;const n=i(7093);Object.defineProperty(t,"generateActiveToken",{enumerable:!0,get:function(){return n.generateActiveToken}}),Object.defineProperty(t,"isEmptyObject",{enumerable:!0,get:function(){return n.isEmptyObject}}),Object.defineProperty(t,"randomTokenString",{enumerable:!0,get:function(){return n.randomTokenString}}),Object.defineProperty(t,"generateAccessToken",{enumerable:!0,get:function(){return n.generateAccessToken}}),Object.defineProperty(t,"generateRefreshToken",{enumerable:!0,get:function(){return n.generateRefreshToken}}),Object.defineProperty(t,"generateJwtToken",{enumerable:!0,get:function(){return n.generateJwtToken}});const r=o(i(1495));t.Logger=r.default;const a=o(i(6907));t.sendMail=a.default;const u=i(3222);Object.defineProperty(t,"validateEmail",{enumerable:!0,get:function(){return u.validateEmail}}),Object.defineProperty(t,"validPhone",{enumerable:!0,get:function(){return u.validPhone}});const d=o(i(4893));t.validateEnv=d.default},1495:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(7773)),n=s.default.createLogger({transports:[new s.default.transports.File({filename:"logs/error.log",level:"error"}),new s.default.transports.File({filename:"logs/combined.log"})],format:s.default.format.combine(s.default.format.colorize({all:!0}),s.default.format.simple())});t.default=n},6907:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5184),r=i(6781),a=s(i(1495)),u=`${process.env.MAIL_CLIENT_ID}`,d=`${process.env.MAIL_CLIENT_SECRET}`,c=`${process.env.MAIL_REFRESH_TOKEN}`,l=`${process.env.SENDER_EMAIL_ADDRESS}`;t.default=(e,t,i)=>o(void 0,void 0,void 0,(function*(){const o=new r.OAuth2Client(u,d,"https://developers.google.com/oauthplayground");o.setCredentials({refresh_token:c});try{const s=yield o.getAccessToken(),r=n.createTransport({service:"gmail",auth:{type:"OAuth2",user:l,clientId:u,clientSecret:d,refreshToken:c,access_token:s}}),a={from:l,to:e,subject:"IT Network",html:`<div style="max-width: 700px; margin:auto; border: 5px solid #009efd; padding: 50px 20px; font-size: 110%;">\n        <h2 style="text-align: center; text-transform: uppercase;color: teal;">Chào mừng tới IT Network.</h2>\n        <p>Xin chúc mừng! Bạn sắp bắt đầu sử dụng IT Network.\n          Chỉ cần nhấp vào nút bên dưới để xác thực địa chỉ email của bạn.\n        </p>\n        \n        <a href=${t} style="background: #85eb7d; text-decoration: none; color: white; padding: 10px 20px; margin: 10px 0; display: inline-block;">${i}</a>\n  \n        <p>Nếu nút không hoạt động vì bất kỳ lý do gì, bạn cũng có thể nhấp vào liên kết bên dưới (test-api)):</p>\n        \n        <div>${t}</div>\n       </div>`};return yield r.sendMail(a)}catch(e){a.default.error(e)}}))},3222:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validateEmail=t.validPhone=void 0,t.validPhone=function(e){return/^[+]/g.test(e)},t.validateEmail=function(e){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}},4893:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=i(9381);t.default=()=>{(0,o.cleanEnv)(process.env,{NODE_ENV:(0,o.str)(),MONGODB_URI:(0,o.str)()})}},4679:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(9905),r=s(i(7701));t.default=class{constructor(){this.authService=new r.default,this.register=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body;yield this.authService.register(i),(0,n.validateEmail)(i.account)&&t.status(200).json({message:"Success! Please check your email."})}catch(e){i(e)}})),this.activeAccount=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const{active_token:i}=e.body;yield this.authService.activeAccount(i),t.json({message:"Account has been activated!"})}catch(e){i(e)}})),this.login=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=yield this.authService.login(i);t.cookie("jwt",o.access_token,{httpOnly:!0,maxAge:1728e5}),t.status(200).json(o)}catch(e){i(e)}})),this.logout=(e,t,i)=>{try{t.clearCookie("jwt"),t.status(200).json({message:"Logout successfully!"})}catch(e){i(e)}},this.getCurrentLogginUser=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.authService.getCurrentLogginUser(e.user.id);t.status(200).json(i)}catch(e){i(e)}})),this.forgotPassword=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const{account:i}=e.body,o=yield this.authService.forgotPassword(i);t.status(200).json(o)}catch(e){i(e)}})),this.resetPassword=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id;yield this.authService.resetPassword(i,o),t.status(200).json({message:"Password successfully changed!"})}catch(e){i(e)}})),this.updatePassword=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const{password_old:i,password:o}=e.body,s=e.user.id;yield this.authService.updatePassword(i,o,s),t.status(200).json({message:"Password successfully changed!"})}catch(e){i(e)}})),this.refreshToken=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body.refresh_token,o=yield this.authService.refreshToken(i);t.cookie("jwt",o.access_token,{httpOnly:!0,maxAge:1728e5}),t.status(200).json(o)}catch(e){i(e)}})),this.revokeToken=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body.token;yield this.authService.revokeToken(i),t.status(200)}catch(e){i(e)}}))}}},2679:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(2333),r=i(6860),a=o(i(4679));t.default=class{constructor(){this.path="/api/v1/auth",this.router=(0,r.Router)(),this.authController=new a.default,this.initializeRoutes()}initializeRoutes(){this.router.post(this.path+"/register",(0,s.validationMiddleware)(n.RegisterDto,!0),this.authController.register),this.router.post(this.path+"/active",this.authController.activeAccount),this.router.post(this.path+"/login",this.authController.login),this.router.post(this.path+"/logout",this.authController.logout),this.router.post(this.path+"/refresh-token",this.authController.refreshToken),this.router.post(this.path+"/revoke-token",this.authController.revokeToken),this.router.post(this.path+"/forgot-password",this.authController.forgotPassword),this.router.post(this.path+"/reset-password",s.authMiddleware,this.authController.resetPassword),this.router.post(this.path+"/update-password",s.authMiddleware,this.authController.updatePassword),this.router.get(this.path,s.authMiddleware,this.authController.getCurrentLogginUser)}}},7701:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=i(1616),u=i(2333),d=s(i(8432)),c=s(i(9344));t.default=class{constructor(){this.userSchema=u.UserSchema,this.CLIENT_URL=`${process.env.BASE_URL}`}register(e){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(e))throw new n.HttpException(400,"Model is empty");if(yield this.userSchema.findOne({account:e.account}).exec())throw new n.HttpException(409,`Your email ${e.account} already exist`);const t=yield d.default.genSalt(10),i=yield d.default.hash(e.password,t),o=String(e.account).trim().toLowerCase(),s=Object.assign(Object.assign({},e),{account:o,password:i}),a=(0,r.generateActiveToken)(s),u=`${this.CLIENT_URL}/active_account/${a}`;(0,r.validateEmail)(e.account)&&(0,r.sendMail)(s.account,u,"Xác nhận email")}))}activeAccount(e){return o(this,void 0,void 0,(function*(){const t=c.default.verify(e,process.env.ACTIVE_TOKEN_SECRET),{fullname:i,account:o,password:s,gender:r}=t;if(yield this.userSchema.findOne({account:o}).exec())throw new n.HttpException(400,"Account already exists.");const a=new this.userSchema({fullname:i,account:o,password:s,gender:r});return yield a.save()}))}login(e){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(e))throw new n.HttpException(400,"Model is empty");const t=String(e.account).trim().toLowerCase(),i=yield this.userSchema.findOne({account:t}).exec();if(!i)throw new n.HttpException(409,`Your email ${e.account} is not exist.`);if(!(yield d.default.compare(e.password,i.password)))throw new n.HttpException(400,"Password is not match");const o=yield this.generateRefreshToken(i._id);return(0,r.generateJwtToken)(i._id,o.token)}))}getCurrentLogginUser(e){return o(this,void 0,void 0,(function*(){const t=yield this.userSchema.findById(e).select("-password").populate("saved",["content","images","user"]).populate("followers followings friends.user friend_requests.user",["fullname","avatar"]).exec();if(!t)throw new n.HttpException(409,"User is not exist.");return t}))}forgotPassword(e){return o(this,void 0,void 0,(function*(){const t=yield this.userSchema.findOne({account:e}).exec();if(!t)throw new n.HttpException(409,"User is not exist.");const i=(0,r.generateAccessToken)({id:t._id}),o=`${this.CLIENT_URL}/reset_password/${i}`;if((0,r.validateEmail)(e))throw(0,r.sendMail)(e,o,"Xác nhận"),new n.HttpException(200,"Success! Please check your email.");return t}))}resetPassword(e,t){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(e))throw new n.HttpException(400,"Model is empty");const i=yield d.default.genSalt(10),o=yield d.default.hash(e.password,i);return yield this.userSchema.findOneAndUpdate({_id:t},{password:o}).exec()}))}updatePassword(e,t,i){return o(this,void 0,void 0,(function*(){if(!t)throw new n.HttpException(400,"Password is not valid!");if(t.length<6)throw new n.HttpException(400,"Password must be more than 6 characters!");const o=yield this.userSchema.findById(i).exec();if(!(yield d.default.compare(e,o.password)))throw new n.HttpException(400,"Password is not match");const s=yield d.default.genSalt(10),r=yield d.default.hash(t,s);return o.password=r,yield o.save(),o}))}refreshToken(e){return o(this,void 0,void 0,(function*(){const t=yield this.getRefreshTokenFromDb(e),{user:i}=t,o=yield this.generateRefreshToken(i);return t.revoked=new Date(Date.now()),t.replacedByToken=o.token,yield t.save(),yield o.save(),(0,r.generateJwtToken)(i,o.token)}))}revokeToken(e){return o(this,void 0,void 0,(function*(){const t=yield this.getRefreshTokenFromDb(e);t.revoked=new Date(Date.now()),yield t.save()}))}getRefreshTokenFromDb(e){return o(this,void 0,void 0,(function*(){const t=yield a.RefreshTokenSchema.findOne({token:e}).populate("user").exec();if(r.Logger.info(t),!t||!t.isActive)throw new n.HttpException(400,"Invalid refresh token");return t}))}generateRefreshToken(e){return o(this,void 0,void 0,(function*(){return new a.RefreshTokenSchema({user:e,token:(0,r.randomTokenString)(),expires:new Date(Date.now()+6048e5)})}))}}},6924:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(9759));t.default=class{constructor(){this.commentService=new n.default,this.getAllComment=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.commentService.getAllComment(e.query);t.status(200).json(i)}catch(e){i(e)}})),this.createComment=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=yield this.commentService.createComment(o,i);t.status(201).json(s)}catch(e){i(e)}})),this.updateComment=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=e.params.id,n=yield this.commentService.updateComment(o,s,i);t.status(200).json(n)}catch(e){i(e)}})),this.deleteComment=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id;yield this.commentService.deleteComment(i,o),t.status(200).json({message:"Delete Comment!"})}catch(e){i(e)}})),this.likeComment=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id;yield this.commentService.likeComment(i,o),t.status(200).json({message:"Like post"})}catch(e){i(e)}})),this.unlikedComment=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id;yield this.commentService.unLikedComment(i,o),t.status(200).json({message:"Unliked post"})}catch(e){i(e)}}))}}},355:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({content:{type:String,required:!0},tag:Object,likes:[{type:s.default.Types.ObjectId,ref:"user"}],user:{type:s.default.Types.ObjectId,ref:"user"},postId:s.default.Types.ObjectId,reply:s.default.Types.ObjectId,postUserId:s.default.Types.ObjectId},{timestamps:!0});t.default=s.default.model("comment",n)},5178:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(6924)),a=o(i(9200));t.default=class{constructor(){this.path="/api/v1/comment",this.router=(0,n.Router)(),this.commentController=new r.default,this.initializeRoutes()}initializeRoutes(){this.router.get(`${this.path}`,this.commentController.getAllComment),this.router.post(`${this.path}`,(0,s.validationMiddleware)(a.default,!0),s.authMiddleware,this.commentController.createComment),this.router.put(`${this.path}/:id`,(0,s.validationMiddleware)(a.default,!0),s.authMiddleware,this.commentController.updateComment),this.router.delete(`${this.path}/:id`,s.authMiddleware,this.commentController.deleteComment),this.router.put(`${this.path}/:id/like`,s.authMiddleware,this.commentController.likeComment),this.router.put(`${this.path}/:id/unlike`,s.authMiddleware,this.commentController.unlikedComment)}}},9759:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=i(2484),u=s(i(355));t.default=class{constructor(){this.commentSchema=u.default,this.postSchema=a.PostSchema}getAllComment(e){return o(this,void 0,void 0,(function*(){const t=new r.APIfeatures(this.commentSchema.find(),e).paginating().sorting();return{data:yield t.query,totalRows:yield this.commentSchema.countDocuments().exec()}}))}createComment(e,t){return o(this,void 0,void 0,(function*(){const{content:i,postId:o,postUserId:s,reply:r,tag:a}=t,u=yield this.postSchema.findById(o);if(!u)throw new n.HttpException(400,"Post is not found");if(r&&!(yield this.commentSchema.findById(r)))throw new n.HttpException(400,"This comment is not exit");const d=new this.commentSchema({user:e,content:i,postId:o,reply:r,tag:a,postUserId:s});yield this.postSchema.findOneAndUpdate({_id:o},{$push:{comments:d._id}},{new:!0}).exec();const c=yield d.save();return yield u.save(),c}))}updateComment(e,t,i){return o(this,void 0,void 0,(function*(){const{content:o}=i,s=yield this.commentSchema.findOneAndUpdate({_id:t,user:e},{content:o},{new:!0}).exec();if(!s)throw new n.HttpException(400,"Comment not found");return s}))}deleteComment(e,t){return o(this,void 0,void 0,(function*(){const e=yield this.commentSchema.findById(t).exec();if(yield e.remove(),!e)throw new n.HttpException(400,"This comment is not exit");yield this.postSchema.findOneAndUpdate({_id:null==e?void 0:e.postId},{$pull:{comments:t}},{new:!0}).exec()}))}likeComment(e,t){return o(this,void 0,void 0,(function*(){if((yield this.commentSchema.find({_id:t,likes:e}).exec()).length>0)throw new n.HttpException(400,"You liked this comment.");if(!(yield this.commentSchema.findOneAndUpdate({_id:t},{$push:{likes:e}},{new:!0}).exec()))throw new n.HttpException(400,"This comment does not exist.")}))}unLikedComment(e,t){return o(this,void 0,void 0,(function*(){if(!(yield this.commentSchema.findOneAndUpdate({_id:t},{$pull:{likes:e}},{new:!0}).exec()))throw new n.HttpException(400,"This comment does not exist.")}))}}},9200:function(e,t,i){var o=this&&this.__decorate||function(e,t,i,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,i,r):s(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r};Object.defineProperty(t,"__esModule",{value:!0});const s=i(5849);class n{constructor(e,t,i,o,s){this.content=e,this.tag=t,this.reply=i,this.postId=o,this.postUserId=s}}o([(0,s.IsNotEmpty)()],n.prototype,"content",void 0),o([(0,s.IsNotEmpty)()],n.prototype,"postId",void 0),t.default=n},1094:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CommentRoute=t.CommentSchema=void 0;const s=o(i(5178));t.CommentRoute=s.default;const n=o(i(355));t.CommentSchema=n.default},6942:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(5443));t.default=class{constructor(){this.conversationService=new n.default,this.getAllCnv=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.conversationService.getAllConversation(e.query);t.status(200).json(i)}catch(e){i(e)}})),this.getConversations=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.conversationService.getConversations(e.user.id,e.query);t.status(200).json(i)}catch(e){i(e)}})),this.isReadConv=(e,t,i)=>o(this,void 0,void 0,(function*(){try{yield this.conversationService.isReadConv(e.params.id),t.status(200).json({message:"Read conversation"})}catch(e){i(e)}})),this.isUnReadConv=(e,t,i)=>o(this,void 0,void 0,(function*(){try{yield this.conversationService.isUnReadConv(e.params.id),t.status(200).json({message:"UnRead conversation"})}catch(e){i(e)}})),this.deleteConversations=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id;yield this.conversationService.deleteConversation(i,o),t.status(200).json({message:"Delete converstion successfully"})}catch(e){i(e)}}))}}},3423:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({recipients:[{type:s.default.Types.ObjectId,ref:"user"}],text:String,media:Array,call:Object,isRead:{type:Boolean,default:!1}},{timestamps:!0});t.default=s.default.model("conversation",n)},8479:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(6942));t.default=class{constructor(){this.path="/api/v1/conversations",this.router=(0,n.Router)(),this.conversationControler=new r.default,this.initializeRoutes()}initializeRoutes(){this.router.get(`${this.path}`,s.authMiddleware,this.conversationControler.getConversations),this.router.get(`${this.path}/all`,s.authMiddleware,this.conversationControler.getAllCnv),this.router.put(`${this.path}/isRead/:id`,s.authMiddleware,this.conversationControler.isReadConv),this.router.put(`${this.path}/isUnRead/:id`,s.authMiddleware,this.conversationControler.isUnReadConv),this.router.delete(`${this.path}/:id`,s.authMiddleware,this.conversationControler.deleteConversations)}}},5443:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=i(5717),u=s(i(3423));t.default=class{constructor(){this.conversationSchema=u.default,this.messageSchema=a.MessageSchema}getAllConversation(e){return o(this,void 0,void 0,(function*(){const t=new r.APIfeatures(this.conversationSchema.find(),e);return{data:yield t.query,totalRows:yield this.conversationSchema.countDocuments().exec()}}))}getConversations(e,t){return o(this,void 0,void 0,(function*(){const i=new r.APIfeatures(this.conversationSchema.find({recipients:e}).populate("recipients","avatar account fullname").sort("-updatedAt"),t),o=yield this.conversationSchema.find({recipients:e,isRead:!1}).exec();return{data:yield i.query,totalRows:o.length}}))}isReadConv(e){return o(this,void 0,void 0,(function*(){return yield this.conversationSchema.findOneAndUpdate({recipients:e},{isRead:!0},{new:!0})}))}isUnReadConv(e){return o(this,void 0,void 0,(function*(){return yield this.conversationSchema.findOneAndUpdate({recipients:e},{isRead:!1},{new:!0})}))}deleteConversation(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.conversationSchema.findOneAndDelete({$or:[{recipients:[e,t]},{recipients:[t,e]}]}).exec();if(!i)throw new n.HttpException(400,"Conversation is not found");yield this.messageSchema.deleteMany({conversation:null==i?void 0:i._id})}))}}},9577:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConversationRoute=t.ConversationSchema=void 0;const s=o(i(3423));t.ConversationSchema=s.default;const n=o(i(8479));t.ConversationRoute=n.default},6145:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.index=(e,t,i)=>{try{t.status(200).json({message:"Hello world. API is running..."})}catch(e){i(e)}}}}},304:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(6860),n=o(i(6145));t.default=class{constructor(){this.path="/",this.router=(0,s.Router)(),this.indexController=new n.default,this.initializeRoutes()}initializeRoutes(){this.router.get(this.path,this.indexController.index)}}},1570:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.IndexRoute=t.IndexControler=void 0;const s=o(i(6145));t.IndexControler=s.default;const n=o(i(304));t.IndexRoute=n.default},9648:function(e,t,i){var o=this&&this.__decorate||function(e,t,i,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,i,r):s(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r};Object.defineProperty(t,"__esModule",{value:!0});const s=i(5849);class n{constructor(e,t,i,o,s,n){this.conversation=e,this.sender=t,this.recipient=i,this.text=o,this.media=s,this.call=n}}o([(0,s.IsNotEmpty)()],n.prototype,"conversation",void 0),o([(0,s.IsNotEmpty)()],n.prototype,"sender",void 0),o([(0,s.IsNotEmpty)()],n.prototype,"recipient",void 0),o([(0,s.IsNotEmpty)()],n.prototype,"text",void 0),t.default=n},5717:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MessageRoute=t.MessageSchema=void 0;const s=o(i(4720));t.MessageSchema=s.default;const n=o(i(2069));t.MessageRoute=n.default},8937:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(2490));t.default=class{constructor(){this.messageService=new n.default,this.addMessage=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=yield this.messageService.addMessage(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.getMessages=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.messageService.getMessages(i,o,e.query);t.status(200).json(s)}catch(e){i(e)}})),this.deleteMessage=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id;yield this.messageService.deleteMessage(i,o),t.status(200).json({message:"Delete Message successfully"})}catch(e){i(e)}}))}}},4720:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({conversation:{type:s.default.Types.ObjectId,ref:"conversation"},sender:{type:s.default.Types.ObjectId,ref:"user"},recipient:{type:s.default.Types.ObjectId,ref:"user"},text:String,media:Array,call:Object},{timestamps:!0});t.default=s.default.model("message",n)},2069:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(9648)),a=o(i(8937));t.default=class{constructor(){this.path="/api/v1/messages",this.router=(0,n.Router)(),this.messageController=new a.default,this.initializeRoutes()}initializeRoutes(){this.router.get(`${this.path}/:id`,s.authMiddleware,this.messageController.getMessages),this.router.post(`${this.path}`,(0,s.validationMiddleware)(r.default,!0),s.authMiddleware,this.messageController.addMessage),this.router.delete(`${this.path}/:id`,s.authMiddleware,this.messageController.deleteMessage)}}},2490:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=i(9577),u=s(i(4720));t.default=class{constructor(){this.conversationSchema=a.ConversationSchema,this.messageSchema=u.default}addMessage(e,t){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(e))throw new n.HttpException(400,"Model is empty");let{sender:i,recipient:o,text:s,media:a,call:u}=e;i=t;const d=yield this.conversationSchema.findOneAndUpdate({$or:[{recipients:[i,o]},{recipients:[o,i]}]},{recipients:[i,o],text:s,media:a,call:u},{new:!0,upsert:!0}).exec(),c=new this.messageSchema({conversation:d._id,sender:i,call:u,recipient:o,text:s,media:a});return yield c.save(),c}))}getMessages(e,t,i){return o(this,void 0,void 0,(function*(){const o=new r.APIfeatures(this.messageSchema.find({$or:[{sender:e,recipient:t},{sender:t,recipient:e}]}),i).paginating(),s=yield o.query;return{data:s,totalRows:s.length}}))}deleteMessage(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.messageSchema.findById(t).exec();if(!i)throw new n.HttpException(400,"Message not found");if(i.sender.toString()!==e)throw new n.HttpException(400,"User is not authorized");return yield i.remove(),i}))}}},7012:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t,i,o,s,n,r){this.id=e,this.recipients=t,this.url=i,this.text=o,this.content=s,this.image=n,this.isRead=r}}},484:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationRoute=t.NotificationSchema=void 0;const s=o(i(5216));t.NotificationSchema=s.default;const n=o(i(3496));t.NotificationRoute=n.default},4980:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(4037));t.default=class{constructor(){this.notificationService=new n.default,this.createNotify=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=yield this.notificationService.createNotify(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.getNotifies=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.notificationService.getNotifies(e.user.id);t.status(200).json(i)}catch(e){i(e)}})),this.deleteNotify=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=e.query.url,s=yield this.notificationService.deleteNotify(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.isReadNotify=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=yield this.notificationService.isReadNotify(i);t.status(200).json(o)}catch(e){i(e)}})),this.deleteAllNotifies=(e,t,i)=>o(this,void 0,void 0,(function*(){try{yield this.notificationService.deleteAllNotifies(e.user.id),t.status(200).json({message:"Delete all notifies"})}catch(e){i(e)}}))}}},5216:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({id:s.default.Types.ObjectId,user:{type:s.default.Types.ObjectId,ref:"user"},recipients:[s.default.Types.ObjectId],url:String,text:String,content:String,image:String,isRead:{type:Boolean,default:!1}},{timestamps:!0});t.default=s.default.model("notification",n)},3496:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(7012)),a=o(i(4980));t.default=class{constructor(){this.path="/api/v1/notification",this.router=(0,n.Router)(),this.notificationControler=new a.default,this.initializeRoutes()}initializeRoutes(){this.router.post(`${this.path}`,(0,s.validationMiddleware)(r.default),s.authMiddleware,this.notificationControler.createNotify),this.router.get(`${this.path}`,s.authMiddleware,this.notificationControler.getNotifies),this.router.delete(`${this.path}/deleteAllNotify`,s.authMiddleware,this.notificationControler.deleteAllNotifies),this.router.delete(`${this.path}/:id`,s.authMiddleware,this.notificationControler.deleteNotify),this.router.put(`${this.path}/isReadNotify/:id`,s.authMiddleware,this.notificationControler.isReadNotify)}}},4037:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=s(i(5216));t.default=class{constructor(){this.notificationSchema=a.default}createNotify(e,t){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(e))throw new n.HttpException(400,"Model is empty");const{id:i,recipients:o,url:s,text:a,content:u,image:d}=e,c=new this.notificationSchema({id:i,recipients:o,url:s,text:a,content:u,image:d,user:t});return yield c.save(),c}))}getNotifies(e){return o(this,void 0,void 0,(function*(){return{data:yield this.notificationSchema.find({recipients:e}).sort("-createdAt").populate("user","avatar fullname"),totalRows:(yield this.notificationSchema.find({recipients:e,isRead:!1})).length}}))}deleteNotify(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.notificationSchema.deleteMany({id:e,url:t});if(!i)throw new n.HttpException(400,"Nofity is not found");return i}))}isReadNotify(e){return o(this,void 0,void 0,(function*(){return yield this.notificationSchema.findOneAndUpdate({_id:e},{isRead:!0},{new:!0})}))}deleteAllNotifies(e){return o(this,void 0,void 0,(function*(){yield this.notificationSchema.deleteMany({recipients:e})}))}}},7672:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t){this.content=e,this.images=t}}},2484:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostRoute=t.PostSchema=void 0;const s=o(i(3));t.PostRoute=s.default;const n=o(i(2279));t.PostSchema=n.default},9602:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(6135));t.default=class{constructor(){this.postService=new n.default,this.createPost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.body,s=yield this.postService.createPost(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.getAllPosts=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.postService.getAllPosts(e.query);t.status(200).json(i)}catch(e){i(e)}})),this.getFollowPosts=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=yield this.postService.getFollowPosts(e.query,i);t.status(200).json(o)}catch(e){i(e)}})),this.getPostById=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.postService.getPostById(e.params.id);t.status(200).json(i)}catch(e){i(e)}})),this.getUserPosts=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=yield this.postService.getUserPosts(i,e.query);t.status(200).json(o)}catch(e){i(e)}})),this.updatePost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=e.body,s=yield this.postService.updatePost(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.deletePost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.postService.deletePost(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.deleteManyPosts=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=yield this.postService.deleteManyPosts(i);t.status(200).json(o)}catch(e){i(e)}})),this.likePost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.postService.likePost(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.unLikePost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.postService.unLikePost(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.savePost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.postService.savePost(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.unSavePost=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.postService.unSavePost(i,o);t.status(200).json(s)}catch(e){i(e)}}))}}},2279:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({content:String,images:{type:Array},likes:[{type:s.default.Types.ObjectId,ref:"user"}],comments:[{type:s.default.Types.ObjectId,ref:"comment"}],user:{type:s.default.Types.ObjectId,ref:"user"}},{timestamps:!0});t.default=s.default.model("post",n)},3:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(7672)),a=o(i(9602));t.default=class{constructor(){this.path="/api/v1/posts",this.router=(0,n.Router)(),this.postController=new a.default,this.initializeRoutes()}initializeRoutes(){this.router.post(`${this.path}`,(0,s.validationMiddleware)(r.default,!0),s.authMiddleware,this.postController.createPost),this.router.get(`${this.path}`,this.postController.getAllPosts),this.router.get(`${this.path}/follow`,s.authMiddleware,this.postController.getFollowPosts),this.router.get(`${this.path}/:id`,this.postController.getPostById),this.router.get(`${this.path}/user-posts/:id`,this.postController.getUserPosts),this.router.put(`${this.path}/:id`,(0,s.validationMiddleware)(r.default,!0),s.authMiddleware,this.postController.updatePost),this.router.delete(`${this.path}/:id`,s.authMiddleware,this.postController.deletePost),this.router.delete(this.path,s.authMiddleware,s.authAdmin,this.postController.deleteManyPosts),this.router.put(`${this.path}/:id/like`,s.authMiddleware,this.postController.likePost),this.router.put(`${this.path}/:id/unlike`,s.authMiddleware,this.postController.unLikePost),this.router.put(`${this.path}/save-post/:id`,s.authMiddleware,this.postController.savePost),this.router.put(`${this.path}/unsaved-post/:id`,s.authMiddleware,this.postController.unSavePost)}}},6135:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=i(1094),u=i(2333),d=s(i(2279));t.default=class{constructor(){this.postSchema=d.default,this.userSchema=u.UserSchema,this.commentSchema=a.CommentSchema}createPost(e,t){return o(this,void 0,void 0,(function*(){const{content:i,images:o}=t;return yield this.postSchema.create({content:i,images:o,user:e})}))}getAllPosts(e){return o(this,void 0,void 0,(function*(){const t=new r.APIfeatures(this.postSchema.find().populate("user likes",["fullname","avatar","followings","followers"]).populate({path:"comments",populate:{path:"user likes",select:"fullname avatar account"}}),e).paginating().sorting();return{data:yield t.query,totalRows:yield this.postSchema.countDocuments().exec()}}))}getFollowPosts(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findOne({_id:t}).populate("followings","_id").exec(),o=null==i?void 0:i.followings,s=new r.APIfeatures(this.postSchema.find({user:[...o,t]}).populate("user likes",["fullname","avatar","followings","followers"]).populate({path:"comments",populate:{path:"user likes",select:"fullname avatar account"}}),e).paginating().sorting(),n=yield s.query;return{data:n,totalRows:n.length}}))}getPostById(e){return o(this,void 0,void 0,(function*(){const t=yield this.postSchema.findById(e).populate("user likes",["fullname","avatar","followings","followers"]).populate({path:"comments",populate:{path:"user likes",select:"-password"}}).exec();if(!t)throw new n.HttpException(400,"Post is not found.");return t}))}getUserPosts(e,t){return o(this,void 0,void 0,(function*(){const i=new r.APIfeatures(this.postSchema.find({user:e}).populate("user likes",["fullname","avatar","followings","followers"]).populate({path:"comments",populate:{path:"user likes",select:"fullname avatar account"}}),t).paginating().sorting(),o=yield i.query;return{data:o,totalRows:o.length}}))}updatePost(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.postSchema.findByIdAndUpdate(e,Object.assign({},t),{new:!0}).populate("user",["fullname","avatar"]).exec();if(!i)throw new n.HttpException(400,"Post is not found");return i}))}deletePost(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.postSchema.findById(t).exec();if(!i)throw new n.HttpException(400,"Post not found");if(i.user.toString()!==e)throw new n.HttpException(400,"User is not authorized");return yield i.remove(),yield this.commentSchema.deleteMany({_id:{$in:i.comments}}),yield this.userSchema.findOneAndUpdate({_id:e},{$pull:{saved:t}},{new:!0}).exec(),i}))}deleteManyPosts(e){return o(this,void 0,void 0,(function*(){const t=yield this.postSchema.deleteMany({_id:[...e]}).exec();if(!t)throw new n.HttpException(40,"PostId is invalid");return t.deletedCount}))}likePost(e,t){return o(this,void 0,void 0,(function*(){if((yield this.postSchema.find({_id:t,likes:e}).populate("user likes",["fullname","avatar","followings","followers"]).exec()).length>0)throw new n.HttpException(400,"You liked this post.");const i=yield this.postSchema.findOneAndUpdate({_id:t},{$push:{likes:e}},{new:!0}).populate("user likes",["fullname","avatar","followings","followers"]).exec();if(!i)throw new n.HttpException(400,"This post does not exist.");return i}))}unLikePost(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.postSchema.findOneAndUpdate({_id:t},{$pull:{likes:e}},{new:!0}).populate("user likes",["fullname","avatar","followings","followers"]).exec();if(!i)throw new n.HttpException(400,"This post does not exist.");return i}))}savePost(e,t){return o(this,void 0,void 0,(function*(){if((yield this.userSchema.find({_id:e,saved:t}).exec()).length>0)throw new n.HttpException(400,"You saved this post.");const i=yield this.userSchema.findOneAndUpdate({_id:e},{$push:{saved:t}},{new:!0}).exec();if(!i)throw new n.HttpException(400,"This user does not exist.");return i}))}unSavePost(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findOneAndUpdate({_id:e},{$pull:{saved:t}},{new:!0}).exec();if(!i)throw new n.HttpException(400,"This user does not exist.");return i}))}}},1433:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{}},6697:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{}},6161:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e,t,i,o,s,n,r,a){this.location=e,this.bio=t,this.skills=i,this.twitter=o,this.instagram=s,this.linkedin=n,this.facebook=r,this.github=a}}},418:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProfileSchema=t.ProfileRoute=void 0;const s=o(i(4731));t.ProfileRoute=s.default;const n=o(i(4202));t.ProfileSchema=n.default},2641:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(7074));t.default=class{constructor(){this.profileService=new n.default,this.getCurrentProfile=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=yield this.profileService.getCurrentProfile(i);t.status(200).json(o)}catch(e){i(e)}})),this.ceateProfile=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=yield this.profileService.createProfile(o,i);t.status(201).json({data:s})}catch(e){i(e)}})),this.getAllProfiles=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const e=yield this.profileService.getAllProfiles();t.status(200).json(e)}catch(e){i(e)}})),this.getProfileByUserId=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=yield this.profileService.getProfileByUserId(i);t.status(200).json(o)}catch(e){i(e)}})),this.deleteProfile=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id;yield this.profileService.deleteProfile(i),t.status(200).json({message:"Delete profile successfully"})}catch(e){i(e)}})),this.createExperience=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=yield this.profileService.addExperience(o,i);t.status(201).json(s)}catch(e){i(e)}})),this.deleteExperience=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=e.user.id;yield this.profileService.deleteExperience(o,i),t.status(200).json({message:"Delete experience successfully"})}catch(e){i(e)}})),this.createEducation=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=e.user.id,s=yield this.profileService.addEducation(o,i);t.status(201).json(s)}catch(e){i(e)}})),this.deleteEducation=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.params.id,o=e.user.id;yield this.profileService.deleteEducation(o,i),t.status(200).json({message:"Delete experience successfully"})}catch(e){i(e)}}))}}},4202:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({user:{type:s.default.Schema.Types.ObjectId,ref:"user"},bio:{type:String},location:{type:String},skills:{type:[String]},experiences:[{title:{type:String,required:!0},company:{type:String},from:{type:Date,required:!0},to:{type:Date},current:{type:Boolean,default:!1}}],educations:[{school:{type:String,required:!0},from:{type:Date,required:!0},to:{type:Date},current:{type:Boolean,default:!1}}],socail:{twitter:{type:String},facebook:{type:String},linkedin:{type:String},instagram:{type:String},github:{type:String}}},{timestamps:!0});t.default=s.default.model("profile",n)},4731:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(1433)),a=o(i(6697)),u=o(i(6161)),d=o(i(2641));t.default=class{constructor(){this.path="/api/v1/profile",this.router=(0,n.Router)(),this.profileController=new d.default,this.initializeRoutes()}initializeRoutes(){this.router.get(`${this.path}`,s.authMiddleware,s.authAdmin,this.profileController.getAllProfiles),this.router.get(`${this.path}/me`,s.authMiddleware,this.profileController.getCurrentProfile),this.router.post(`${this.path}`,(0,s.validationMiddleware)(u.default),s.authMiddleware,this.profileController.ceateProfile),this.router.get(`${this.path}/:id`,s.authMiddleware,this.profileController.getProfileByUserId),this.router.delete(`${this.path}/:id`,s.authMiddleware,this.profileController.deleteProfile),this.router.put(`${this.path}/experience`,(0,s.validationMiddleware)(a.default),s.authMiddleware,this.profileController.createExperience),this.router.put(`${this.path}/experience/:id`,s.authMiddleware,this.profileController.deleteExperience),this.router.put(`${this.path}/education`,(0,s.validationMiddleware)(r.default),s.authMiddleware,this.profileController.createEducation),this.router.put(`${this.path}/education/:id`,s.authMiddleware,this.profileController.deleteEducation)}}},7074:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(2333),a=s(i(1195)),u=s(i(4202));t.default=class{constructor(){this.profileSchema=u.default,this.userSchema=r.UserSchema}getCurrentProfile(e){return o(this,void 0,void 0,(function*(){const t=yield this.profileSchema.findOne({user:e}).populate("user",["fullname","avatar"]).exec();if(!t)throw new n.HttpException(400,"There is no profile for this user");return t}))}createProfile(e,t){return o(this,void 0,void 0,(function*(){const{location:i,bio:o,skills:s,twitter:n,instagram:r,linkedin:d,facebook:c,github:l}=t,h={user:e,location:i,bio:o,skills:Array.isArray(s)?s:s.split(",").map((e=>e.trim()))},f={twitter:n,instagram:r,linkedin:d,facebook:c,github:l};for(const[e,t]of Object.entries(f))t&&t.length>0&&(f[e]=(0,a.default)(t,{forceHttps:!0}));return h.socail=f,yield u.default.findOneAndUpdate({user:e},{$set:h},{new:!0,upsert:!0,setDefaultsOnInsert:!0}).exec()}))}getAllProfiles(){return o(this,void 0,void 0,(function*(){return{data:yield this.profileSchema.find().populate("user",["fullname","avatar"]).exec(),totalRows:yield this.profileSchema.countDocuments().exec()}}))}getProfileByUserId(e){return o(this,void 0,void 0,(function*(){const t=yield this.profileSchema.findOne({user:e}).exec();if(!t)throw new n.HttpException(404,"Profile is not exists");return t}))}deleteProfile(e){return o(this,void 0,void 0,(function*(){yield this.profileSchema.findOneAndRemove({user:e}).exec()}))}addExperience(e,t){return o(this,void 0,void 0,(function*(){const i=Object.assign({},t),o=yield this.profileSchema.findOne({user:e}).exec();if(!o)throw new n.HttpException(400,"There is not profile for this user");return o.experiences.unshift(i),yield o.save(),o}))}deleteExperience(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.profileSchema.findOne({user:e}).exec();if(!i)throw new n.HttpException(400,"There is not profile for this user");i.experiences=i.experiences.filter((e=>e._id.toString()!==t)),yield i.save()}))}addEducation(e,t){return o(this,void 0,void 0,(function*(){const i=Object.assign({},t),o=yield this.profileSchema.findOne({user:e}).exec();if(!o)throw new n.HttpException(400,"There is not profile for this user");return o.educations.unshift(i),yield o.save(),o}))}deleteEducation(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.profileSchema.findOne({user:e}).exec();if(!i)throw new n.HttpException(400,"There is not profile for this user");i.educations=i.educations.filter((e=>e._id.toString()!==t)),yield i.save()}))}}},1616:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RefreshTokenSchema=void 0;const s=o(i(4380));t.RefreshTokenSchema=s.default},4380:function(e,t,i){var o=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,s)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&o(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const r=n(i(1185)),a=new r.default.Schema({user:{type:r.Schema.Types.ObjectId,ref:"user"},token:String,expires:Date,created:{type:Date,default:Date.now},createdByIp:String,revoked:Date,revokedByIp:String,replacedByToken:String});a.virtual("isExpired").get((function(){return Date.now()>=this.expires.getTime()})),a.virtual("isActive").get((function(){return!this.revoked&&!this.isExpired})),a.set("toJSON",{virtuals:!0,versionKey:!1,transform:function(e,t){delete t._id,delete t.id,delete t.user}}),t.default=r.default.model("refreshToken",a)},5246:function(e,t,i){var o=this&&this.__decorate||function(e,t,i,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,i,r):s(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r};Object.defineProperty(t,"__esModule",{value:!0});const s=i(5849);class n{constructor(e,t,i,o,s,n){this.fullname=e,this.account=t,this.password=i,this.avatar=o,this.coverImg=n,this.gender=s}}o([(0,s.IsNotEmpty)(),(0,s.MaxLength)(25)],n.prototype,"fullname",void 0),o([(0,s.IsNotEmpty)(),(0,s.IsEmail)()],n.prototype,"account",void 0),o([(0,s.IsNotEmpty)(),(0,s.MinLength)(6)],n.prototype,"password",void 0),o([(0,s.IsNotEmpty)()],n.prototype,"avatar",void 0),o([(0,s.IsNotEmpty)()],n.prototype,"gender",void 0),t.default=n},2333:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegisterDto=t.UserSchema=t.UsersRoute=void 0;const s=o(i(5246));t.RegisterDto=s.default;const n=o(i(8499));t.UserSchema=n.default;const r=o(i(7939));t.UsersRoute=r.default},5887:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(i(6149));t.default=class{constructor(){this.userService=new n.default,this.createUser=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=yield this.userService.createUser(i);t.status(200).json(o)}catch(e){i(e)}})),this.getAll=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.userService.getAll(e.query);t.status(200).json(i)}catch(e){i(e)}})),this.getUserById=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=yield this.userService.getUserById(e.params.id);t.status(200).json(i)}catch(e){i(e)}})),this.updateUser=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=yield this.userService.updateUser(e.user.id,i);t.status(200).json(o)}catch(e){i(e)}})),this.updateUsersRole=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const{role:i}=e.body,o=yield this.userService.updateUsersRole(i,e.params.id);t.status(200).json(o)}catch(e){i(e)}})),this.deleteUser=(e,t,i)=>o(this,void 0,void 0,(function*(){try{yield this.userService.deleteUser(e.params.id),t.status(200).json({message:"Delete successfully"})}catch(e){i(e)}})),this.deleteManyUsers=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.body,o=yield this.userService.deleteManyUsers(i);t.status(200).json(o)}catch(e){i(e)}})),this.searchUsers=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.query.keyword;if(i){const e=yield this.userService.searchUser(i);t.status(200).json(e)}else t.status(200).json([])}catch(e){i(e)}})),this.follow=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.userService.follow(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.unFollow=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.userService.unFollow(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.addFiend=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.userService.addFiend(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.unFiend=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.userService.unFiend(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.acceptFiendRequest=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.params.id,s=yield this.userService.acceptFiendRequest(i,o);t.status(200).json(s)}catch(e){i(e)}})),this.suggestionUser=(e,t,i)=>o(this,void 0,void 0,(function*(){try{const i=e.user.id,o=e.query.num,s=yield this.userService.suggestionUser(i,o);t.status(200).json(s)}catch(e){i(e)}}))}}},8499:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(i(1185)),n=new s.default.Schema({fullname:{type:String,required:!0},account:{type:String,required:[!0,"Please add your email or phone"],trim:!0,unique:!0},password:{type:String,required:!0},avatar:{type:String,default:"https://res.cloudinary.com/dwgximj2j/image/upload/v1650776061/avatars/avatar_d8bwej.jpg"},coverImg:{type:String,default:"https://res.cloudinary.com/dwgximj2j/image/upload/v1649480694/avatars/dev-cover_utacnt.jpg"},gender:{type:String,default:"male"},role:{type:Number,default:0},followings:[{type:s.default.Schema.Types.ObjectId,ref:"user"}],followers:[{type:s.default.Schema.Types.ObjectId,ref:"user"}],friends:[{user:{type:s.default.Schema.Types.ObjectId,ref:"user"},date:{type:Date,default:Date.now}}],friend_requests:[{user:{type:s.default.Schema.Types.ObjectId,ref:"user"},date:{type:Date,default:Date.now}}],saved:[{type:s.default.Types.ObjectId,ref:"post"}]},{timestamps:!0});t.default=s.default.model("user",n)},7939:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7382),n=i(6860),r=o(i(5246)),a=o(i(5887));t.default=class{constructor(){this.path="/api/v1/users",this.router=(0,n.Router)(),this.userController=new a.default,this.initializeRoutes()}initializeRoutes(){this.router.post(this.path,(0,s.validationMiddleware)(r.default,!0),this.userController.createUser),this.router.get(`${this.path}/search`,s.authMiddleware,this.userController.searchUsers),this.router.get(`${this.path}/suggest_user`,s.authMiddleware,this.userController.suggestionUser),this.router.get(this.path,s.authMiddleware,s.authAdmin,this.userController.getAll),this.router.get(`${this.path}/:id`,s.authMiddleware,this.userController.getUserById),this.router.put(this.path,(0,s.validationMiddleware)(r.default,!0),s.authMiddleware,this.userController.updateUser),this.router.put(`${this.path}/update_role/:id`,s.authMiddleware,s.authAdmin,this.userController.updateUsersRole),this.router.delete(`${this.path}/:id`,s.authMiddleware,s.authAdmin,this.userController.deleteUser),this.router.delete(this.path,s.authMiddleware,s.authAdmin,this.userController.deleteManyUsers),this.router.put(`${this.path}/follow/:id`,s.authMiddleware,this.userController.follow),this.router.put(`${this.path}/unfollow/:id`,s.authMiddleware,this.userController.unFollow),this.router.post(`${this.path}/friend/:id`,s.authMiddleware,this.userController.addFiend),this.router.delete(`${this.path}/friend/:id`,s.authMiddleware,this.userController.unFiend),this.router.put(`${this.path}/friend/:id`,s.authMiddleware,this.userController.acceptFiendRequest)}}},6149:function(e,t,i){var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(s,n){function r(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}u((o=o.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(5729),r=i(9905),a=i(1094),u=i(2484),d=i(418),c=s(i(8432)),l=i(6781),h=s(i(8499));t.default=class{constructor(){this.userSchema=h.default,this.commentSchema=a.CommentSchema,this.profileSchema=d.ProfileSchema,this.postSchema=u.PostSchema,this.client=new l.OAuth2Client(`${process.env.MAIL_CLIENT_ID}`),this.CLIENT_URL=`${process.env.BASE_URL}`}createUser(e){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(e))throw new n.HttpException(400,"Model is empty");if(yield this.userSchema.findOne({account:e.account}).exec())throw new n.HttpException(409,`Your email ${e.account} already exist`);const t=yield c.default.genSalt(10),i=yield c.default.hash(e.password,t),o=String(e.account).trim().toLowerCase();return yield this.userSchema.create(Object.assign(Object.assign({},e),{account:o,password:i}))}))}getAll(e){return o(this,void 0,void 0,(function*(){const t=new r.APIfeatures(this.userSchema.find().select("-password").populate("followers followings friends.user friend_requests.user",["fullname","avatar"]),e).paginating().sorting();return{data:yield t.query,totalRows:yield this.userSchema.countDocuments().exec()}}))}getUserById(e){return o(this,void 0,void 0,(function*(){const t=yield this.userSchema.findById(e).select("-password").populate("followers followings friends.user friend_requests.user",["fullname","avatar"]).exec();if(!t)throw new n.HttpException(404,"User is not exists");return t}))}updateUser(e,t){return o(this,void 0,void 0,(function*(){if((0,r.isEmptyObject)(t))throw new n.HttpException(400,"Model is empty");const{fullname:i,avatar:o,gender:s}=t,a=yield this.userSchema.findOneAndUpdate({_id:e},{fullname:i,avatar:o,gender:s},{new:!0}).exec();if(!a)throw new n.HttpException(400,"Your id is valid");return a}))}updateUsersRole(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findOneAndUpdate({_id:t},{role:e},{new:!0}).exec();if(!i)throw new n.HttpException(400,"Your id is valid");return i}))}deleteUser(e){return o(this,void 0,void 0,(function*(){const t=yield this.userSchema.findByIdAndDelete(e).exec();if(!t)throw new n.HttpException(400,"Your id is valid");return yield this.profileSchema.findOneAndRemove({user:e}).exec(),yield this.commentSchema.findOneAndRemove({user:e}).exec(),yield this.postSchema.findOneAndRemove({user:e}).exec(),t}))}deleteManyUsers(e){return o(this,void 0,void 0,(function*(){const t=yield this.userSchema.deleteMany({_id:[...e]}).exec();if(yield this.profileSchema.deleteMany({user:[...e]}).exec(),yield this.commentSchema.deleteMany({user:[...e]}).exec(),yield this.postSchema.deleteMany({user:[...e]}).exec(),!t)throw new n.HttpException(409,"Your id is invalid");return t.deletedCount}))}searchUser(e){return o(this,void 0,void 0,(function*(){return e=new RegExp(e,"i"),yield this.userSchema.find({$or:[{fullname:e}]}).limit(10).select("fullname account avatar").exec()}))}follow(e,t){return o(this,void 0,void 0,(function*(){if((yield this.userSchema.find({_id:t,followers:e})).length>0)throw new n.HttpException(400,"You followed this user.");const i=yield this.userSchema.findByIdAndUpdate({_id:t},{$push:{followers:e}},{new:!0}).populate("followers followings","-password").exec();return yield this.userSchema.findByIdAndUpdate({_id:e},{$push:{followings:t}},{new:!0}).populate("followers followings","-password").exec(),i}))}unFollow(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findByIdAndUpdate({_id:t},{$pull:{followers:e}},{new:!0}).select("-password -followers -following -friend_requests -friend").populate("followers followings").exec();return yield this.userSchema.findByIdAndUpdate({_id:e},{$pull:{followings:t}},{new:!0}).select("-password -followers -following -friend_requests -friend").populate("followers followings").exec(),i}))}addFiend(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findOne({_id:e}).exec();if(!i)throw new n.HttpException(400,"your account is not found");const o=yield this.userSchema.findOne({_id:t}).exec();if(!o)throw new n.HttpException(400,"Target user is not found");if(i.friend_requests&&i.friend_requests.some((e=>e.toString()===t)))throw new n.HttpException(400,"You has been already send a friend request to this user");if(o.friends&&o.friends.some((t=>t.toString()===e)))throw new n.HttpException(400,"Target user has already been friend by from user");return o.friend_requests||(o.friend_requests=[]),o.friend_requests.unshift({user:e}),yield o.save(),o}))}unFiend(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findOne({_id:e}).exec();if(!i)throw new n.HttpException(400,"your account is not found");const o=yield this.userSchema.findOne({_id:t}).exec();if(!o)throw new n.HttpException(400,"Target user is not found");if(i.friends&&i.friends.some((e=>e.toString()===t)))throw new n.HttpException(400,"You has not been yet friend this user");if(o.friends&&o.friends.some((t=>t.toString()===e)))throw new n.HttpException(400,"You has not being friend this user");return i.friends||(i.friends=[]),i.friends=i.friends.filter((({user:e})=>e.toString()!==t)),o.friends||(o.friends=[]),o.friends=o.friends.filter((({user:t})=>t.toString()!==e)),yield i.save(),yield o.save(),i}))}acceptFiendRequest(e,t){return o(this,void 0,void 0,(function*(){const i=yield this.userSchema.findOne({_id:e}).exec();if(!i)throw new n.HttpException(400,"your account is not found");const o=yield this.userSchema.findOne({_id:t}).exec();if(!o)throw new n.HttpException(400,"Target user is not found");if(o.friends&&o.friends.some((t=>t.toString()===e)))throw new n.HttpException(400,"You has already been friend");if(i.friends&&i.friends.some((e=>e.toString()===t)))throw new n.HttpException(400,"You has already been friend");return i.friend_requests||(i.friend_requests=[]),i.friend_requests=i.friend_requests.filter((({user:e})=>e.toString()!==t)),i.friends||(i.friends=[]),i.friends.unshift({user:t}),o.friends||(o.friends=[]),o.friends.unshift({user:e}),yield i.save(),yield o.save(),i}))}suggestionUser(e,t){return o(this,void 0,void 0,(function*(){const i=t||10,o=yield this.userSchema.aggregate([{$match:{_id:{$nin:[e]}}},{$sample:{size:Number(i)}},{$lookup:{from:"users",localField:"followers",foreignField:"_id",as:"followers"}},{$lookup:{from:"users",localField:"followings",foreignField:"_id",as:"followings"}},{$project:{fullname:1,account:1,avatar:1}}]);return{data:o,totalRows:o.length}}))}}},7728:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),i(1081);const s=o(i(6752)),n=i(9905),r=i(1570),a=i(2333),u=o(i(2679)),d=i(418),c=i(2484),l=i(1094),h=i(5717),f=i(9577),p=i(484);(0,n.validateEnv)();const v=[new r.IndexRoute,new a.UsersRoute,new u.default,new d.ProfileRoute,new c.PostRoute,new l.CommentRoute,new h.MessageRoute,new f.ConversationRoute,new p.NotificationRoute];new s.default(v).listen()},7455:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=i(9905);let s=[];t.default=e=>{e.on("join-user",(t=>{t&&(s.push({id:t._id,socketId:e.id,followers:t.followers}),o.Logger.info({users:s}))})),e.on("disconnect",(()=>{const t=s.find((t=>t.socketId===e.id));if(t){const i=s.filter((e=>t.followers.find((t=>t._id===e.id))));i.length>0&&i.forEach((i=>{e.to(`${i.socketId}`).emit("check-user-offline",t.id)}))}s=s.filter((t=>t.socketId!==e.id))})),e.on("create-post",(t=>{e.broadcast.emit("create-post-to-client",t)})),e.on("update-post",(t=>{e.broadcast.emit("update-post-to-client",t)})),e.on("delete-post",(t=>{e.broadcast.emit("delete-post-to-client",t)})),e.on("like-post",(t=>{const i=[...t.user.followers,...t.user.followings,t.user._id],o=s.filter((e=>i.includes(e.id)));o.length>0&&o.forEach((i=>{e.to(`${i.socketId}`).emit("like-to-client",t)}))})),e.on("unlike-post",(t=>{const i=[...t.user.followers,...t.user.followings,t.user._id],o=s.filter((e=>i.includes(e.id)));o.length>0&&o.forEach((i=>{e.to(`${i.socketId}`).emit("unlike-to-client",t)}))})),e.on("create-comment",(t=>{e.broadcast.emit("create-comment-to-client",t)})),e.on("update-comment",(t=>{e.broadcast.emit("update-comment-to-client",t)})),e.on("delete-comment",(t=>{e.broadcast.emit("delete-comment-to-client",t)})),e.on("like-comment",(t=>{e.broadcast.emit("like-comment-to-client",t)})),e.on("unLike-comment",(t=>{e.broadcast.emit("unLike-comment-to-client",t)})),e.on("follow",(t=>{const i=s.find((e=>e.id===t._id));i&&e.to(`${i.socketId}`).emit("follow-to-client",t)})),e.on("unFollow",(t=>{const i=s.find((e=>e.id===t._id));i&&e.to(`${i.socketId}`).emit("unFollow-to-client",t)})),e.on("create-notify",(t=>{const i=s.find((e=>t.recipients.includes(e.id)));i&&e.to(`${i.socketId}`).emit("create-notify-to-client",t)})),e.on("remove-notify",(t=>{const i=s.find((e=>t.recipients.includes(e.id)));i&&e.to(`${i.socketId}`).emit("remove-notify-to-client",t)})),e.on("send-message",(({sender:t,recipient:i,text:o,media:n})=>{const r=s.find((e=>e.id===i));r&&e.to(r.socketId).emit("get-message",{sender:t,text:o,media:n})})),e.on("delete-message",(t=>{const i=s.find((e=>e.id===t.recipient));i&&e.to(`${i.socketId}`).emit("delete-message-to-client",t)})),e.on("check-user-online",(t=>{if(t){const i=s.filter((e=>t.followings.find((t=>t._id===e.id))));e.emit("check-user-online-to-me",i);const o=s.filter((e=>t.followers.find((t=>t._id===e.id))));o.length>0&&o.forEach((i=>{e.to(`${i.socketId}`).emit("check-user-online-to-client",t._id)}))}}))}},8432:e=>{e.exports=require("bcryptjs")},136:e=>{e.exports=require("class-transformer")},5849:e=>{e.exports=require("class-validator")},9710:e=>{e.exports=require("cookie-parser")},3582:e=>{e.exports=require("cors")},1081:e=>{e.exports=require("dotenv/config")},9381:e=>{e.exports=require("envalid")},6860:e=>{e.exports=require("express")},6781:e=>{e.exports=require("google-auth-library")},7806:e=>{e.exports=require("helmet")},3487:e=>{e.exports=require("hpp")},9344:e=>{e.exports=require("jsonwebtoken")},1185:e=>{e.exports=require("mongoose")},9470:e=>{e.exports=require("morgan")},5184:e=>{e.exports=require("nodemailer")},1195:e=>{e.exports=require("normalize-url")},3952:e=>{e.exports=require("socket.io")},9948:e=>{e.exports=require("swagger-ui-express")},7773:e=>{e.exports=require("winston")},5477:e=>{e.exports=require("yamljs")},6113:e=>{e.exports=require("crypto")},3685:e=>{e.exports=require("http")}},t={};!function i(o){var s=t[o];if(void 0!==s)return s.exports;var n=t[o]={exports:{}};return e[o].call(n.exports,n,n.exports,i),n.exports}(7728)})();